<style>
	#red-ui-sidebar-smxstate-content, #red-ui-sidebar-smxstate-graph {
		width: 100%;
		height: 100%;
	}
</style>

<script type="text/x-red" data-template-name="smxstate">
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row" style="margin-bottom: 0px;">
        <label for="node-input-xstateDefinition" style="width: 200px"><i class="fa fa-wrench"></i> XState State-machine</label>
        <input type="hidden" id="node-input-xstateDefinition" autofocus="autofocus">
        <input type="hidden" id="node-input-noerr">
    </div>
    <div class="form-row node-text-editor-row" style="position:relative">
        <div style="position: absolute; right:0; bottom:calc(100% + 3px);"><button id="node-smxstate-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-xstateDefinition-editor" ></div>
    </div>
</script>

<script type="text/javascript" src="smxstate-client-util.js" inline></script>
<script type="text/javascript">

	// Get the default state machine via file inclusion
	var defaultStateMachineCode = !!!!include('../tmp/defaultStateMachine.escape.js');

	RED.nodes.registerType('smxstate',{
		category: 'function',
		color: '#C7E9C0',
		defaults: {
			name: { value: "" },
			xstateDefinition: { value: defaultStateMachineCode },
			noerr: { value:0, required:true, validate:(v) => !v }
		},
		inputs:1,
		outputs:3,
		icon: "function.png",
		label: function() {
			return this.name || "smxstate";
		},
		inputLabels: "trigger",
		outputLabels: ["changed", "statusChanged", "dataChanged" ], 
		oneditprepare: function() {

			var that = this;

			this.editor = RED.editor.createEditor({
				id: 'node-input-xstateDefinition-editor',
				mode: 'ace/mode/nrjavascript',
				value: $("#node-input-xstateDefinition").val(),
				globals: {
					msg:true,
					context:true,
					RED: true,
					util: true,
					flow: true,
					global: true,
					console: true,
					Buffer: true,
					setTimeout: true,
					clearTimeout: true,
					setInterval: true,
					clearInterval: true
				}
			});

			this.editor.focus();

			RED.popover.tooltip($("#node-smxstate-expand-js"), RED._("node-red:common.label.expand"));

			$("#node-smxstate-expand-js").on("click", function(e) {
				e.preventDefault();
				var value = that.editor.getValue();
				RED.editor.editJavaScript({
					value: value,
					width: "Infinity",
					cursor: that.editor.getCursorPosition(),
					mode: "ace/mode/nrjavascript",
					complete: function(v,cursor) {
						that.editor.setValue(v, -1);
						that.editor.gotoLine(cursor.row+1,cursor.column,false);
						setTimeout(function() {
							that.editor.focus();
						},300);
					}
				})
			})
		},
		oneditsave: function() {
			var annot = this.editor.getSession().getAnnotations();
			this.noerr = 0;
			$("#node-input-noerr").val(0);
			for (var k=0; k < annot.length; k++) {
				//console.log(annot[k].type,":",annot[k].text, "on line", annot[k].row);
				if (annot[k].type === "error") {
					$("#node-input-noerr").val(annot.length);
					this.noerr = annot.length;
				}
			}
			$("#node-input-xstateDefinition").val(this.editor.getValue());

			// TODO trigger update on panel to redraw state machine

			this.editor.destroy();
			delete this.editor;
		},
		oneditcancel: function() {
			this.editor.destroy();
			delete this.editor;
		},
		oneditresize: function(size) {
			var rows = $("#dialog-form>div:not(.node-text-editor-row)");
			var height = $("#dialog-form").height();
			for (var i=0; i<rows.length; i++) {
				height -= $(rows[i]).outerHeight(true);
			}
			var editorRow = $("#dialog-form>div.node-text-editor-row");
			height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
			$(".node-text-editor").css("height",height+"px");
			this.editor.resize();
		},
		onpaletteadd: function() {
			var that = this;
			let uiComponents = RED.smxstate.init();
			var uiObserver   = new MutationObserver(function(mutations) {
				// This gets fired when the sidebar is shown or hidden
				let visible = $(mutations[0].target).is(':visible');

				if( visible ) {
					RED.comms.unsubscribe('smxstate_transition', that.handleStateMachineTransition);
					RED.comms.subscribe('smxstate_transition', that.handleStateMachineTransition);

					// The runtime now sends state transition information of the last selected state-machine id
				} else {
					RED.comms.unsubscribe('smxstate_transition', that.handleStateMachineTransition);
				}
			});

			RED.sidebar.addTab({
				id: 'smxstate',
				label: 'state-machines',
				name: 'State-machines',
				content: uiComponents.content,
				toolbar: $('<div><span class="button-group"><a id="red-ui-sidebar-smxstate-open" class="red-ui-footer-button" href="#"><i class="fa fa-desktop"></i></a></span></div>'),
				enableOnEdit: true,
				pinned: false,
				iconClass: 'fa fa-dot-circle-o',
				action: 'contrib:show-smxstate-tab'
			});
			RED.actions.add('contrib:show-smxstate-tab', function() {
				RED.sidebar.show('smxstate');
			});

			RED.events.on("nodes:add", function(node) { 
				if( node.hasOwnProperty("type") && node.type == "smxstate" ) {
					// DO NOTHING!
				}
			});

			// Select the parent container for our sidebar
			let sidebarContainer = document.querySelector('#red-ui-sidebar-smxstate-content').closest('div[style]');
			
			// Setup the observer
			uiObserver.observe(sidebarContainer, {
				attributes:true
			});

			// TODO: Extra view window
			RED.popover.tooltip($("#red-ui-sidebar-smxstate-open"),RED._('node-red:debug.sidebar.openWindow'));
			$("#red-ui-sidebar-smxstate-open").on("click", function(e) {
					e.preventDefault();
					alert("NOT YET IMPLEMENTED");
					return;
					subWindow = window.open(document.location.toString().replace(/[?#].*$/,"")+"debug/view/view.html"+document.location.search,"nodeREDDebugView","menubar=no,location=no,toolbar=no,chrome,height=500,width=600");
					subWindow.onload = function() {
						subWindow.postMessage({event:"workspaceChange",activeWorkspace:RED.workspaces.active()},"*");
					};
				});

			
			// Subscribe to comms
			this.handleStateMachineTransition = function(t,o) {
				if( !(typeof o === "object") || !("type" in o) || o.type !== "transition" ) return;

				let id = o.id;
				
				// Animate graph
				// TODO: Probably add a checkbox in the panel to enable/disable animation
				RED.smxstate.animate(o);
			};

			this.handleStateMachineDisplay = function(t,o) {
				if( !(typeof o === "object") || !("type" in o) ) return;

				switch( o.type.toLowerCase() ) {
					case 'add':
						// Add to sidebar
						if( !Array.isArray(o.data) ) o.data = [o.data];
						for( let el of o.data )
						RED.smxstate.addStatemachineToSidebar(el.id, el.path.labels.join('/'), el.rootId, el.alias);
						break;
					case 'delete':
						// Remove from sidebar
						if( !Array.isArray(o.data) ) o.data = [o.data];
						for( let el of o.data ) 
							RED.smxstate.deleteStatemachineFromSidebar(el.id);

						break;
				}
			}

			RED.comms.subscribe('smxstate', this.handleStateMachineDisplay);
		},
		onpaletteremove: function() {
			RED.comms.unsubscribe('smxstate', this.handleStateMachineDisplay);
			RED.comms.unsubscribe('smxstate_transition', this.handleStateMachineTransition);
			RED.sidebar.removeTab('smxstate');
			RED.actions.remove("contrib:show-smxstate-tab");

			delete RED.smxstate;
		}
	});
</script>

<script type="text/x-red" data-help-name="smxstate">
	<p>A finite state machine implementation for node red</p>

	<h3>Properties</h3>
		<dl class="message-properties">
			<dt>name<span class="property-type">string</span></dt>
			<dd>The name of the node as displayed in the editor</dd>
			<dt>FSM<span class="property-type">json </span></dt>
			<dd>
	The json object which descibes the state machine.
	It needs to contain the initial state and possible transitions.
	For more information see details below</dd>
			<dt>Send initial state<span class="property-type">boolean </span></dt>
			<dd>Enable to trigger sending the intital state after 100ms after the flow is started.</dd>
			<dt>Show transition errors<span class="property-type">boolean </span></dt>
			<dd>Enable / disable error msgs when triggering actions.</dd>
		</dl>

	<h3>Inputs</h3>
	<dl class="message-properties">
	<dt>topic <span class="property-type">string</span></dt>
	<dd>
		- <i>reset</i> to reset to initial state<br/>
		- <i>[transition]</i> to trigger a state change<br/>
	</dd>
		<dt>payload <span class="property-type">json</span> </dt>
		<dd>
			May contain a json payload, to add to the state output Example: <code>{ "x" : 10.0, y: "test" }</code>
		 </dd>
	</dl>

	<h3>Outputs</h3>
	<ol class="node-ports">
		<p>All outputs output the same data format: a msg, with its payload containing a <i>status</i> and a <i>data</i> object</p>
		<li>changed
			<dl class="message-properties">
				<dt>payload <span class="property-type">json</span></dt>
				<dd>Outputs the new state when there is any change in state.</dd>
			</dl>
        </li>
        <li>statusChanged
			<dl class="message-properties">
				<dt>payload <span class="property-type">json</span></dt>
				<dd>Outputs the new state only when the machine transitioned to a new status.</dd>
			</dl>
        </li>
        <li>dataChanged
			<dl class="message-properties">
				<dt>payload <span class="property-type">json</span></dt>
				<dd>Outputs the new state only when the data object of the state is changed.</dd>
			</dl>
		</li>
	</ol>

	<h3>Details</h3>
	<p>Example json code for FSM:
<pre>{
  "state": {
    "status": "IDLE",
    "data" : { "x": 5 }
  },
  "transitions": {
    "IDLE": {
      "run": "RUNNING"
    },
    "RUNNING": {
      "stop": "IDLE"
    }
  }
}</pre>
	<ul>
		<li><i>state</i> holds the initial state. It needs to contain a <i>status</i> field and might contain a <i>data</i> object</li>
		<li><i>transitions</i> holds the possible states as Keys (the upper case strings). As Values it holds one or more Key-Value Pairs, consisting of the transition (lower case strings) and the resulting state.</li>
		<li>sending a msg with the topic set to the transition to the node, will trigger a state change.</li>
		<li><i>reset</i> is a reserved transition to reset the machine to its initial state, so it cannot be used in the transition table.</li>
	</ul>
	</p>

</script>
